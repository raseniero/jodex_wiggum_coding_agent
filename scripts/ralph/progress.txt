## Codebase Patterns
- Edition is 2021 in Cargo.toml
- Project root contains Cargo.toml and src/main.rs (standard binary layout)
- Use `anyhow` for error handling throughout
- Use `#[serde(rename_all = "camelCase")]` for JSON structs matching prd.json
- Error pattern: `eprintln!("Error: {err:#}"); std::process::exit(1);` for fatal errors in main
- Functions return `Result<()>` or `Result<T>` with anyhow; caller in `main()` matches and handles errors uniformly
- Use `child.stdin.take()` to get ownership of stdin, write, then drop to signal EOF to child processes
- `run_iteration()` returns accumulated stdout as `String` for downstream processing (completion detection)
- Integration tests go in `tests/cli.rs`; use `assert_cmd::cargo_bin_cmd!` macro (not deprecated `Command::cargo_bin`)
- Use `predicates` crate (v3) for assertion matchers with assert_cmd

# Ralph Progress Log
Started: Fri Feb  6 01:02:17 PST 2026
---

## 2026-02-06 - US-001
- Initialized Cargo project with `cargo init --name ralph`
- Added all required dependencies: clap (v4, derive), serde (v1, derive), serde_json (v1), chrono (v0.4), anyhow (v1)
- Added dev-dependency: assert_cmd (v2)
- Created .gitignore for /target
- Files changed: Cargo.toml, src/main.rs, .gitignore
- **Learnings for future iterations:**
  - `cargo init` with latest Rust stable uses edition "2024" by default; changed to "2021" per PRD requirements
  - Git repo was not initialized — had to run `git init` before any git operations
  - Branch created: `ralph/ralph-loop-rs` as specified in prd.json
---

## 2026-02-06 - US-002
- Implemented CLI argument parsing using clap derive API
- Optional positional `max_iterations` (u32, default 10)
- Optional `--prompt` flag for agent prompt file path (default: CLAUDE.md)
- `--help` and `--version` work correctly
- Invalid arguments produce clear error messages
- Files changed: src/main.rs
- **Learnings for future iterations:**
  - clap derive API with `#[command(version, about)]` auto-pulls version from Cargo.toml and description from doc comment
  - `#[arg(default_value_t = 10)]` for numeric defaults, `#[arg(default_value = "...")]` for string/path defaults
  - clap automatically handles error messages for type mismatches (e.g. non-numeric input for u32)
---

## 2026-02-06 - US-003
- Added `Prd` and `UserStory` structs with serde deserialization
- Implemented `load_prd()` function that reads and validates prd.json from the current working directory
- Missing prd.json prints error to stderr and exits with code 1
- Malformed JSON prints error to stderr and exits with code 1
- Used `#[serde(rename_all = "camelCase")]` for JSON field mapping
- Used `anyhow::Context` for clear, chained error messages
- Files changed: src/main.rs
- **Learnings for future iterations:**
  - `#[allow(dead_code)]` on structs suppresses unused field warnings for deserialization structs whose fields aren't yet consumed
  - `anyhow::Context::with_context` provides clean error chaining for user-facing messages
  - `eprintln!("Error: {err:#}")` with `#` displays the full anyhow error chain on one line
---

## 2026-02-06 - US-004
- Implemented `init_progress_file()` function that creates progress.txt if it doesn't exist
- If progress.txt exists, it is left untouched
- Uses `chrono::Local::now()` for datetime in the header
- Header format: `# Ralph Progress Log\nStarted: <datetime>\n---\n`
- Called from `main()` after `load_prd()`, follows same error pattern
- Files changed: src/main.rs
- **Learnings for future iterations:**
  - `PathBuf::exists()` is the simplest way to check file existence before conditional creation
  - `chrono::Local::now()` Display impl produces a human-readable datetime with timezone
  - New functions follow the pattern: return `Result<()>`, caller matches and does `eprintln!` + `exit(1)`
---

## 2026-02-06 - US-005
- Implemented `run_iteration()` function that reads prompt file and pipes it to `claude --dangerously-skip-permissions --print`
- Uses `std::process::Command` with piped stdin/stdout
- Writes prompt contents to stdin, then drops stdin handle to close it
- Streams stdout line-by-line via `BufReader` (tee behavior) while accumulating into a String
- If `claude` fails to spawn, prints clear error to stderr and exits with code 1
- Main loop iterates from 1 to `max_iterations`, printing a banner each iteration
- Sleeps 2 seconds between iterations (skips sleep after the last one)
- Added `#[allow(dead_code)]` on `Prd` struct to suppress unused field warnings (fields will be consumed in later stories)
- Files changed: src/main.rs
- **Learnings for future iterations:**
  - `child.stdin.take()` is needed to get ownership, write, then drop to signal EOF to the child process
  - `Stdio::inherit()` on stderr lets the child's stderr pass through directly to the terminal
  - `BufReader::lines()` provides clean line-by-line iteration over a `Read` implementor
  - The `_prd` prefix suppresses unused variable warnings but `#[allow(dead_code)]` is needed for unused struct fields
---

## 2026-02-06 - US-006
- Added completion signal detection after each iteration in the main loop
- Checks accumulated output for `<promise>COMPLETE</promise>` string
- If found: prints "Ralph completed all tasks!" and "Completed at iteration {i} of {max}", exits with code 0
- If not found: prints "Iteration {i} complete. Continuing..."
- After all iterations exhaust without completion: prints "Ralph reached max iterations ({max}) without completing all tasks." to stderr and exits with code 1
- Files changed: src/main.rs
- **Learnings for future iterations:**
  - The completion detection is a simple `String::contains()` check on the accumulated output — no regex needed
  - Max iterations exhaustion message goes to stderr (via `eprintln!`) and exits with code 1, consistent with other error exits
  - The `_output` variable from US-005 was renamed to `output` now that it's consumed
---

## 2026-02-06 - US-007
- Added integration tests in `tests/cli.rs` using `assert_cmd` and `predicates` crates
- Test `missing_prd_json_exits_with_error`: runs ralph in a temp dir without prd.json, asserts exit code 1 and stderr mentions "prd.json"
- Test `help_displays_program_description`: runs ralph --help, asserts success and stdout contains "autonomous agent loop"
- Added `predicates = "3"` to dev-dependencies in Cargo.toml
- Files changed: tests/cli.rs, Cargo.toml
- **Learnings for future iterations:**
  - `assert_cmd::cargo_bin_cmd!("ralph")` macro is the non-deprecated way to get a Command for a binary target
  - `predicates::str::contains()` works with `.stderr()` and `.stdout()` for assertion matching
  - Integration tests need `current_dir()` set to a temp directory to isolate from project files (e.g., avoid finding project's own prd.json)
---
